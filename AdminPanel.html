<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8" />
    <link href="/css/StyleSheet.css" rel="stylesheet" />
    <script src="/js/site.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="/css/cropper.min.css" rel="stylesheet" />
    <title>Admin Panel</title>

    <style>
        .AddButton {
            font-weight: bold;
            color: ghostwhite;
            background-color: #4d3718;
            border-radius: 50%;
            font-size: 20px;
            height: 50px;
            width: 50px;
        }

            .AddButton:hover {
                background-color: darkgoldenrod;
                border-color: #4d3718;
            }

        .CategoryDisplay {
            display: flex;
            border-radius: 10px;
            height: 100px;
            width: 400px;
            padding: 20px;
        }

            .CategoryDisplay:hover {
                background-color: #f8cb9a;
            }

            .CategoryDisplay img {
                border-radius: 5px;
                height: 100px;
                width: 100px;
            }

            .CategoryDisplay h3 {
                font-size: 20px;
                font-weight: bold;
                margin: 0px;
                padding: 0px;
            }

            .CategoryDisplay p {
                font-size: 15px;
                color: slategray;
                margin: 0px;
                padding: 0px;
            }
    </style>
</head>
<body>
    <!--Does not load those style parameters from the .css file...-->
    <script>loadDOM('/partials/Navigation.html')</script>

    <div style="display: flex;">
        <script>loadDOM('/partials/AdminPanelMenu.html')</script>

        <div style="display: block; margin: auto">
            <div class="container" style="max-width: 600px">
                <div style="display: flex; justify-content:space-between">
                    <h1 id="pageHeader">Admin Panel</h1>
                    <button class="AddButton" id="AddCategory">+</button>
                </div>
                <div id="pageContent" style="max-height: 400px; overflow:auto">

                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="CategoryModal">
        <div class="modal-content">
            <form id="CategoryForm" style="display:flex; flex-direction:column; align-items:center;">
                <img id="CategoryImage" style="height: 100px; width: 100px; border-radius: 5px; cursor: pointer; margin: 10px"
                     src="https://static.vecteezy.com/system/resources/previews/005/073/059/original/empty-box-concept-illustration-flat-design-eps10-modern-graphic-element-for-landing-page-empty-state-ui-infographic-vector.jpg" />

                <label for="CategoryName">Category Name</label>
                <input type="text" id="CategoryName" name="CategoryName" placeholder="Enter the CategoryName" required>
                <label class="ErrorLabel" style="font-size:12px; color:crimson" id="NameError"></label>

                <label for="PriorityInput">Priority</label>
                <input type="number" id="PriorityInput" name="PriorityInput" placeholder="Enter the Priority" required>
                <label class="ErrorLabel" style="font-size:12px; color:crimson" id="PriorityError"></label>

                <div style="width: 250px; display:flex; justify-content:space-between">
                    <button class="MainButton" style="width: 47%; background-color: slategrey" id="CancelCategory">Cancel</button>
                    <button class="MainButton" style="width: 47%" type="submit">Add</button>
                </div>
            </form>
        </div>
    </div>

    <script>loadDOM('/partials/AvatarEditor.html')</script>
    <script>loadDOM('/partials/LoadingScreen.html')</script>


    <script src="/js/cropper.min.js"></script>
    <script src="/js/AvatarEditor.js"></script>

    <script src="/js/NavbarActions.js"></script>

    <script>
        let cropper;
        const AddCategory = document.getElementById("AddCategory");
        const CategoryImage = document.getElementById("CategoryImage");
        const CancelCategory = document.getElementById("CancelCategory");
        const CategoryName = document.getElementById("CategoryName");
        const PriorityInput = document.getElementById("PriorityInput");
        const CategoryForm = document.getElementById("CategoryForm");
        const PriorityError = document.getElementById("PriorityError");
        const NameError = document.getElementById("NameError");
        const AvatarEditor = document.getElementById('AvatarEditor');

        let uploadedImageURL = Avatar.src;
        AvatarPreview.src = uploadedImageURL;

        CategoryForm.onsubmit = (e) => {
            e.preventDefault();

            clearErrors();

            show_loading();

            const xhr = new XMLHttpRequest();
            const url = "https://goose.itstep.click/api/Categories/add";
            const data = {
                title: CategoryName.value,
                priority: PriorityInput.value,
                urlSlug: generateSlug(CategoryName.value),
                image: CategoryImage.src
            };

            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {

                        console.log("Success:", xhr.responseText);
                        const resp = xhr.responseText;
                        CategoryModal.style.display = "none";
                        hide_loading();
                        fetchCategories();

                    } else if (xhr.status === 400) {
                        HandleError(xhr.responseText);
                    } else {
                        console.error("Error:", xhr.status, xhr.responseText);
                    }
                    hide_loading();
                }
            };

            // Send request
            xhr.send(JSON.stringify(data));
        }

        function clearErrors() {
            NameError.textContent = "";
            CategoryName.style.borderWidth = "1px";
            CategoryName.style.borderColor = "#ccc";

            PriorityError.textContent = "";
            PriorityInput.style.borderWidth = "1px";
            PriorityInput.style.borderColor = "#ccc";
        }

        function HandleError(Response) {
            const errorResponse = JSON.parse(Response);
            const errors = errorResponse.errors;


            Object.keys(errors).forEach(field => {
                const fieldErrors = errors[field];
                let errorLabel;
                let errorInput;
                if (field == "urlSlug") {
                    errorLabel = NameError;
                    NameError.innerText = "Generated Url Slug Error (based on the title): ";
                    errorInput = CategoryName;
                }
                else if (field == "title") {
                    errorLabel = NameError;
                    errorInput = CategoryName;
                }
                else if (field == "firstName") {
                    errorLabel = PriorityError;
                    errorInput = PriorityInput;
                }
                fieldErrors.forEach(message => {
                    errorLabel.textContent += message + "; ";
                    errorInput.style.borderWidth = "5px";
                    errorInput.style.borderColor = "red";
                });
            });
        }

        function generateSlug(text) {
            text = text.toLowerCase();

            text = text.replace(/[^a-z0-9 -]/g, '');

            text = text.replace(/\s+/g, '-');

            text = text.replace(/-+/g, '-');

            const maxLength = 50;
            if (text.length > maxLength) {
                text = text.substr(0, maxLength);
            }

            return text;
        }

        CancelCategory.onclick = (e) => {
            clearCategoryFields();
            CategoryModal.style.display = "none";
        }

        function clearCategoryFields() {
            CategoryName.innerText = "";
            PriorityInput.innerText = "";
        }

        AddCategory.onclick = (e) => {
            const CategoryModal = document.getElementById("CategoryModal");
            CategoryModal.style.display = "block";
        }

        fetchCategories();

        async function fetchCategories() {
            show_loading();
            try {
                const response = await axios.get('https://goose.itstep.click/api/Categories/list', {
                    headers: {
                        'Accept': '*/*'
                    }
                });
                const { data } = response;
                const listCategories = document.getElementById("pageContent");
                const pageHeader = document.getElementById("pageHeader");
                pageHeader.innerText = "Categories";
                listCategories.innerHTML = "";
                data.forEach(item => {
                    listCategories.innerHTML += `
                                                <div class="CategoryDisplay">
                                                    <img src="https://goose.itstep.click/images/200_${item.image}" alt="Category">
                                                    <div style="margin: 0px 0px 0px 10px">
                                                        <h3 >${item.title}<h3>
                                                        <p>Slug: ${item.urlSlug}</p>
                                                        <p>Priority: ${item.priority}</p>
                                                    </div>
                                                    <button style="margin: auto 0px auto auto" onclick="Remove(${item.id})" class="NegativeButton">Remove</button>
                                                </div>
                                                `;
                });
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
            hide_loading();
        }

        async function Remove(id) {
            event.preventDefault();

            try {
                const response = await fetch(`https://goose.itstep.click/api/Categories/delete/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Request failed');
                }

                fetchCategories();
            } catch (error) {
                console.error('Error deleting item:', error);
            }
        }

        CategoryImage.onclick = function (e) {
            AvatarEditor.style.display = 'block';
            let uploadedImageURL = CategoryImage.src;
            AvatarPreview.src = uploadedImageURL;

            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(AvatarPreview, {
                aspectRatio: 1,
                viewMode: 1
            });
        }

        window.onclick = function (event) {
            if (event.target == AvatarEditor) {
                AvatarEditor.style.display = "none";
            }
            if (event.target == CategoryModal) {
                CategoryModal.style.display = "none";
            }
        }

        ConfirmEditor.onclick = function (e) {
            if (cropper) {
                var base64 = cropper.getCroppedCanvas().toDataURL();
                CategoryImage.src = base64;
            }
            AvatarEditor.style.display = "none";
        }
    </script>
</body>
</html>