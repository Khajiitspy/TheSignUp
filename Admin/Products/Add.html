<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link href="/css/StyleSheet.css" rel="stylesheet" />
    <script src="/js/site.js"></script>
    <link href="/css/cropper.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/eo1l2hcz63gv16hu7v7u5zmv1odiufbf17b448zt3aghhh43/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <title>Add Product</title>
    <style>
    </style>
</head>
<body>

    <script>loadDOM('/partials/Navigation.html')</script>

    <div style="display: flex;">
        <script>loadDOM('/partials/AdminPanelMenu.html')</script>
        <div class="container" style="max-width: 800px; max-height: 530px">
            <form id="AddProductForm" style=" display:flex; flex-direction:column; align-items:center;">
                <h1>Add Product</h1>

                <div style="display:flex; flex-direction:column; align-items:center; max-height: 380px; width: 650px; overflow:auto">
                    <label for="ProductName">Product Name</label>
                    <input type="text" id="ProductName" name="ProductName" placeholder="Enter the product name" style="text-align:center; width: 50%" required>
                    <label class="ErrorLabel" style="font-size:12px; color:crimson" id="NameError"></label>

                    <div style="width: 100%; display:flex; justify-content:space-evenly; margin-bottom: 20px">

                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <label for="Category">Category</label>
                            <select id="Category" name="Category" required>
                                <option value="0">Select Category</option>
                            </select>
                            <label class="ErrorLabel" style="font-size:12px; color:crimson" id="CategoryError"></label>
                        </div>

                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <label for="PriorityInput">Priority</label>
                            <input type="number" id="PriorityInput" name="PriorityInput" placeholder="Enter the Priority" required>
                            <label class="ErrorLabel" style="font-size:12px; color:crimson" id="PriorityError"></label>
                        </div>

                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <label for="PriceInput">Price</label>
                            <input type="number" id="PriceInput" name="PriceInput" placeholder="Enter the Price" required>
                            <label class="ErrorLabel" style="font-size:12px; color:crimson" id="PriceError"></label>
                        </div>
                    </div>

                    <div style="max-width: 600px">
                        <textarea id="Description">Describe your product</textarea>
                    </div>

                    <label style="margin-top:20px">Images</label>
                    <div>
                        <input type="file" id="ImageOpener" name="ImageOpener" accept="image/*" multiple />
                    </div>
                    <div id="ImageCollection" style="width: 600px; min-width: 600px; min-height: 205px; display:flex; overflow-x: auto; margin-top: 10px; border: 1px solid #808080; border-radius: 5px; padding:5px">
                    
                    </div>
                </div>

                <div style="width: 100%; display:flex; justify-content:space-between; margin-top: 20px;">
                    <button class="MainButton" style="width: 47%; background-color: slategrey" id="CancelAdd">Cancel</button>
                    <button class="MainButton" style="width: 47%" type="submit">Add</button>
                </div>
            </form>
        </div>
    </div>


    <script>loadDOM('/partials/AvatarEditor.html')</script>
    <script>loadDOM('/partials/LoadingScreen.html')</script>


    <script src="/js/cropper.min.js"></script>
    <script src="/js/AvatarEditor.js"></script>

    <script src="/js/NavbarActions.js"></script>

    <script>
        tinymce.init({
            selector: '#Description',

            plugins: [
                'advlist', 'autolink', 'link', 'image', 'lists', 'charmap', 'preview', 'anchor', 'pagebreak',
                'searchreplace', 'wordcount', 'visualblocks', 'visualchars', 'code', 'fullscreen', 'insertdatetime',
                'media', 'table', 'emoticons', 'help'
            ],
            toolbar: 'undo redo | styles | bold italic | alignleft aligncenter alignright alignjustify | ' +
                'bullist numlist outdent indent | link image | print preview media fullscreen | ' +
                'forecolor backcolor emoticons | help',
            menu: {
                favs: { title: 'My Favorites', items: 'code visualaid | searchreplace | emoticons' }
            },
            menubar: 'favs file edit view insert format tools table help',


        });

        let CancelAdd = document.getElementById("CancelAdd");
        CancelAdd.onclick = (e) => {
            location.href = "/Admin/AdminPanel_Products.html";
        }

        let Form = document.getElementById("AddProductForm");
        document.getElementById('AddProductForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            show_loading();

            const images = ImageCollection.getElementsByTagName('img');
            let IDs = [];

            //Тут ми завантажуємо список фото, які нам потрібно, щоб були на сервері

            for (let i = 0; i < images.length; i++) {
                /*                await uploadImage(images[i]);*/

                console.log(images[i].src)
                const data = {
                    image: images[i].src
                };
                try {
                    const resp = await axios.post('https://goose.itstep.click/api/Products/upload', data);
                    const {id, name} = resp.data;
                    IDs.push(id);
                    console.log(resp);
                }
                catch (error)
                {
                    console.error("Upload image error", error);
                }
            }

            console.log(IDs); //тут є баг Console.log - від всирівно виводить правильні дані, але не вірно.
            //Цей код має працювати лиш тоді, коли усі фото уже на сервері,
            //бо інакше масив IDs - є пустий і ми фото не відправляємо

            const xhr = new XMLHttpRequest();
            const url = "https://goose.itstep.click/api/Products/add";
            const data = {
                name: document.getElementById("ProductName").value,
                priority: document.getElementById("PriorityInput").value,
                categoryId: document.getElementById('Category').value,
                price: document.getElementById("PriceInput").value,
                description: tinymce.activeEditor.getContent(),
                ids: IDs // тут пустий масив - це 100% на сервер фото не підуть
            };

            console.log(data);

            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        hide_loading();
                        console.log("Success:", xhr.responseText);
                    } else {
                        hide_loading();
                        HandleError(xhr.responseText)
                    }
                }
            };

            // Send request
            xhr.send(JSON.stringify(data));



            
        });

        function HandleError(Response) {
            const errorResponse = JSON.parse(Response);
            const errors = errorResponse.errors;

            try {
                Object.keys(errors).forEach(field => {
                    const fieldErrors = errors[field];
                    let errorLabel;
                    let errorInput;
                    if (field == "name") {
                        errorLabel = document.getElementById("NameError");
                        errorInput = document.getElementById("ProductName");
                    }
                    else if (field == "priority") {
                        errorLabel = document.getElementById("PriorityError");
                        errorInput = document.getElementById("PriorityInput");
                    }
                    else if (field == "price") {
                        errorLabel = document.getElementById("PriceError");
                        errorInput = document.getElementById("PriceInput");
                    }
                    else if (field == "categoryId") {
                        errorLabel = document.getElementById("CategoryError");
                        errorInput = document.getElementById("Category");
                    }
                    fieldErrors.forEach(message => {
                        errorLabel.textContent += message + "; ";
                        errorInput.style.borderWidth = "5px";
                        errorInput.style.borderColor = "red";
                    });
                });
            }
            catch {
                console.error("Error:", Response);
            }
        }

        let IDs = [];

        let ImageCollection = document.getElementById("ImageCollection");

        document.getElementById('ImageOpener').addEventListener('change', function (event) {

            const { target } = event;
            const { files } = target;
            const imageCollection = document.getElementById('ImageCollection');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        imageToBase64(e.target.result, function (base64) {
                            const imgContainer = document.createElement('div');
                            imgContainer.style.position = 'relative';
                            imgContainer.style.marginRight = '10px';

                            const img = document.createElement('img');
                            img.src = base64;
                            img.style.width = '200px';
                            img.style.height = '200px';
                            document.body.appendChild(img);

                            const removeButton = document.createElement('button');
                            removeButton.textContent = 'X';
                            removeButton.style.position = 'absolute';
                            removeButton.style.top = '0';
                            removeButton.style.right = '0';
                            removeButton.style.background = 'red';
                            removeButton.style.color = 'white';
                            removeButton.style.border = 'none';
                            removeButton.style.borderRadius = '50%';
                            removeButton.style.width = '20px';
                            removeButton.style.height = '20px';
                            removeButton.style.cursor = 'pointer';
                            removeButton.style.display = 'none';

                            imgContainer.appendChild(img);
                            imgContainer.appendChild(removeButton);
                            imageCollection.appendChild(imgContainer);

                            imgContainer.addEventListener('mouseover', function () {
                                removeButton.style.display = 'block';
                            });

                            imgContainer.addEventListener('mouseout', function () {
                                removeButton.style.display = 'none';
                            });

                            removeButton.addEventListener('click', function () {
                                imageCollection.removeChild(imgContainer);
                            });
                        });
                    };

                    reader.readAsDataURL(file);
                }
            }
        });

        function imageToBase64(imageUrl, callback) {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // This allows cross-origin image loading

            img.onload = function () {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                const base64String = canvas.toDataURL("image/png"); // Converts to base64 (PNG format)
                callback(base64String); // Return the base64 string using the callback
            };

            img.onerror = function (error) {
                console.error("Error loading image", error);
            };

            img.src = imageUrl;
        }

        document.addEventListener("DOMContentLoaded", async () => {
            console.log("Load Dom");
            try {
                var list = await axios.get("https://goose.itstep.click/api/Categories/list");
                const { data } = list;

                // Отримуємо елемент select
                const selectElement = document.getElementById('Category');

                // Для кожної категорії додаємо опцію в селект
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id; // Значення опції - id категорії
                    option.textContent = category.title; // Текст опції - назва категорії
                    selectElement.appendChild(option); // Додаємо опцію до select
                });
                console.log("list categories", list);
            }
            catch (error) {
                console.error("error load category", error);
            }
        });
    </script>
</body>
</html>